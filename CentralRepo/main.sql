<<<<<<< HEAD
CREATE DATABASE QUANLYCHUYENBAY;
GO

USE QUANLYCHUYENBAY;
GO
=======
﻿CREATE DATABASE QuanLyBanVeMayBay
USE QuanLyBanVeMayBay
>>>>>>> 35d8303992bf4d98fde6b9bbafaca486bc0c3256

CREATE TABLE MAYBAY (
<<<<<<< HEAD
    MAMB CHAR(8) PRIMARY KEY,
    TENMAYBAY NVARCHAR(40) NOT NULL,
    HANGSANXUAT NVARCHAR(50) NOT NULL,
    SOGHETHUONG INT NOT NULL,
    SOGHEVIP INT NOT NULL
=======
	MAMB CHAR(8) PRIMARY KEY,
	TENMAYBAY VARCHAR(40) NOT NULL,
	HANGSANXUAT VARCHAR(50) NOT NULL,
	SOGHETHUONG INT,
	SOGHEVIP INT
>>>>>>> 35d8303992bf4d98fde6b9bbafaca486bc0c3256
);
GO

CREATE TABLE SANBAY (
	MASB CHAR(8) PRIMARY KEY,
	TENSB NVARCHAR(40) NOT NULL
);
GO

CREATE TABLE TUYENBAY (
	MATB CHAR(8) PRIMARY KEY,
	MASBDI CHAR(8) FOREIGN KEY REFERENCES SANBAY(MASB),
	MASBDEN CHAR(8) FOREIGN KEY REFERENCES SANBAY(MASB)
);
GO

CREATE TABLE CHUYENBAY (
<<<<<<< HEAD
    MACB CHAR(8) PRIMARY KEY,
    MATB CHAR(8) FOREIGN KEY REFERENCES TUYENBAY(MATB),
    MAMB CHAR(8) FOREIGN KEY REFERENCES MAYBAY(MAMB),
    NGAYKHOIHANH SMALLDATETIME NOT NULL,
    GIOKHOIHANH SMALLDATETIME NOT NULL,
    THOIGIANDUKIEN TIME NOT NULL,
    DIEMDI NVARCHAR(40) NOT NULL,
    DIEMDEN NVARCHAR(40) NOT NULL,
    SOGHEHANGTHUONGCONLAI INT NOT NULL,
    SOGHEHANGVIPCONLAI INT NOT NULL
=======
	MACB CHAR(8) PRIMARY KEY,
	MATB CHAR(8) FOREIGN KEY REFERENCES TUYENBAY(MATB),
	MAMB CHAR(8) FOREIGN KEY REFERENCES MAYBAY(MAMB),
	NGAYKHOIHANH SMALLDATETIME NOT NULL,
	GIOKHOIHANH SMALLDATETIME NOT NULL,
	THOIGIANDUKIEN TIME NOT NULL,
	DIEMDI NVARCHAR(40) NOT NULL,
	DIEMDEN NVARCHAR(40) NOT NULL,
	SOGHEHANGTHUONGCONLAI INT,
	SOGHEHANGVIPCONLAI INT
>>>>>>> 35d8303992bf4d98fde6b9bbafaca486bc0c3256
);
GO

<<<<<<< HEAD
CREATE TABLE VAITRO (
    MAVT CHAR(8) PRIMARY KEY,
    TENVAITRO VARCHAR(50) NOT NULL
=======
-- Tạo bảng VAITRO
CREATE TABLE VAITRO (
	MAVT CHAR(8) PRIMARY KEY,
	TENVAITRO VARCHAR(50) NOT NULL
>>>>>>> 35d8303992bf4d98fde6b9bbafaca486bc0c3256
);
GO

CREATE TABLE NHANVIEN (
<<<<<<< HEAD
    MANV CHAR(8) PRIMARY KEY,
    TENNV NVARCHAR(30) NOT NULL,
    DIACHI NCHAR(50) NOT NULL,
    SODT VARCHAR(10) UNIQUE,
    NGAYSINH SMALLDATETIME NOT NULL,
    NGAYVAOLAM SMALLDATETIME NOT NULL,
    GIOITINH NCHAR(3) NOT NULL,
    EMAIL VARCHAR(50) UNIQUE,
    PASSWORD VARCHAR(25) NOT NULL,
    NGAYTAOTK DATETIME NOT NULL,
    MAVT CHAR(8) FOREIGN KEY REFERENCES VAITRO(MAVT)
=======
	MANV CHAR(8) PRIMARY KEY,
	TENNV NVARCHAR(30) NOT NULL,
	DIACHI NCHAR(50),
	SODT VARCHAR(10) UNIQUE,
	NGAYSINH SMALLDATETIME NOT NULL,
	NGAYVAOLAM SMALLDATETIME NOT NULL,
	GIOITINH NCHAR(3) NOT NULL,
	EMAIL VARCHAR(50) UNIQUE,
	PASSWORD VARCHAR(25) NOT NULL,
	NGAYTAOTK DATETIME NOT NULL,
	MAVT CHAR(8) REFERENCES VAITRO(MAVT)
>>>>>>> 35d8303992bf4d98fde6b9bbafaca486bc0c3256
);
GO

CREATE TABLE KHACHHANG (
<<<<<<< HEAD
    MAKH CHAR(8) PRIMARY KEY,
    TENKH NVARCHAR(30) NOT NULL,
    GIOITINH NCHAR(3) NOT NULL,
    NGAYSINH SMALLDATETIME NOT NULL,
    CCCD NVARCHAR(12) UNIQUE,
    NGAYCAP SMALLDATETIME,
    QUOCTICH NVARCHAR(30) NOT NULL,
    SODT VARCHAR(10) UNIQUE,
    EMAIL VARCHAR(50) UNIQUE,
    DIACHI NCHAR(50) NOT NULL,
    PASSWORD VARCHAR(25) NOT NULL,
    NGAYTAOTK DATETIME NOT NULL,
    MAVT CHAR(8) FOREIGN KEY REFERENCES VAITRO(MAVT)
=======
	MAKH CHAR(8) PRIMARY KEY,
	TENKH NVARCHAR(30) NOT NULL,
	GIOITINH NCHAR(3) NOT NULL,
	NGAYSINH SMALLDATETIME NOT NULL,
	CCCD NVARCHAR(12) UNIQUE,
	NGAYCAP SMALLDATETIME NOT NULL,
	QUOCTICH NVARCHAR(30) NOT NULL,
	SODT VARCHAR(10) UNIQUE,
	EMAIL VARCHAR(50) UNIQUE,
	DIACHI NCHAR(50) NOT NULL,
	PASSWORD VARCHAR(25) NOT NULL,
	NGAYTAOTK DATETIME NOT NULL,
	MAVT CHAR(8) REFERENCES VAITRO(MAVT)
>>>>>>> 35d8303992bf4d98fde6b9bbafaca486bc0c3256
);
GO

<<<<<<< HEAD
CREATE TABLE HOADON (
    MAHD CHAR(8) PRIMARY KEY,
    MANV CHAR(8) FOREIGN KEY REFERENCES NHANVIEN(MANV),
    MAKH CHAR(8) FOREIGN KEY REFERENCES KHACHHANG(MAKH),
    NGAYLAP SMALLDATETIME NOT NULL,
    SOVE INT NOT NULL,
    THANHTIEN MONEY NOT NULL
=======
-- Tạo bảng HANGVE
CREATE TABLE HANGVE (
	MAHV CHAR(8) PRIMARY KEY,
	TENHANGVE NVARCHAR(20) NOT NULL
);

-- Tạo bảng VE
CREATE TABLE VE (
	MAVE CHAR(8) PRIMARY KEY,
	MAHV CHAR(8) FOREIGN KEY REFERENCES HANGVE(MAHV),
	MACB CHAR(8) FOREIGN KEY REFERENCES CHUYENBAY(MACB),
	MAKH CHAR(8) FOREIGN KEY REFERENCES KHACHHANG(MAKH),
	MANV CHAR(8) FOREIGN KEY REFERENCES NHANVIEN(MANV),
	GHE INT UNIQUE,
	GIAVE MONEY NOT NULL
	TINHTRANGDATVE BOOLEAN
	NGAYLAPVE SMALLDATETIME
>>>>>>> 35d8303992bf4d98fde6b9bbafaca486bc0c3256
);
GO

CREATE TABLE HANGVE (
    MAHV CHAR(8) PRIMARY KEY,
    TENHANGVE NVARCHAR(20) NOT NULL
);
GO

<<<<<<< HEAD
CREATE TABLE VE (
    MAVE CHAR(8) PRIMARY KEY,
    MAHV CHAR(8) FOREIGN KEY REFERENCES HANGVE(MAHV),
    MACB CHAR(8) FOREIGN KEY REFERENCES CHUYENBAY(MACB),
    MAHD CHAR(8) FOREIGN KEY REFERENCES HOADON(MAHD),
    GHE CHAR(3) UNIQUE,
    GIAVE MONEY NOT NULL,
);
GO

--Thêm ràng buộc
-->Bảng NHANVIEN<--
ALTER TABLE NHANVIEN ADD CONSTRAINT CHK_SDT CHECK (SODT LIKE '0%');

ALTER TABLE NHANVIEN
ADD CONSTRAINT CHK_NGAYVAOLAM_NGAYSINH CHECK (NGAYVAOLAM > NGAYSINH);

ALTER TABLE NHANVIEN
ADD CONSTRAINT CHK_NGAYTAOTK CHECK (NGAYTAOTK >= NGAYVAOLAM AND NGAYTAOTK >= GETDATE());

--> Bảng KHACHHANG <--
ALTER TABLE KHACHHANG
ADD CONSTRAINT CHK_NGAYCAP_NGAYSINH CHECK (NGAYCAP > NGAYSINH);

ALTER TABLE KHACHHANG ADD CONSTRAINT CHK_SDT_KH CHECK (SODT LIKE '0%');

ALTER TABLE KHACHHANG
ADD CONSTRAINT CHK_NGAYTAOTK_KH CHECK (NGAYTAOTK >= GETDATE());

--> Bảng HOADON <--
ALTER TABLE HOADON
ADD CONSTRAINT CHK_NGAYLAP_HD CHECK (NGAYLAP >=GETDATE());

--> Bảng VE <--
ALTER TABLE VE
ADD CONSTRAINT CHK_GIAVE CHECK (GIAVE >=0)

--> Bảng CHUYENBAY <--

ALTER TABLE CHUYENBAY
ADD CONSTRAINT CHK_DIEMDEN_DIEMDI CHECK (DIEMDEN <> DIEMDI);

ALTER TABLE CHUYENBAY
ADD CONSTRAINT CHK_SOGHEHANGTHUONGCONLAI CHECK (SOGHEHANGTHUONGCONLAI >= 0);

ALTER TABLE CHUYENBAY
ADD CONSTRAINT CHK_SOGHEHANGVIPCONLAI CHECK (SOGHEHANGVIPCONLAI >= 0);

--> Bảng MAYBAY

ALTER TABLE MAYBAY
ADD CONSTRAINT CHK_SOGHETHUONG CHECK (SOGHETHUONG >= 0);
=======

DELIMITER //
CREATE FUNCTION SoLuong_KH_TrongThang (
	p_month INT;
	p_year INT
)
RETURNS INT
DETERMINISTIC
READS SQL DATA
BEGIN 
	DECLARE SLKH INT;
	SELECT COUNT(*) INTO SLKH
	FROM KHACHHANG
	WHERE MONTH(NGAYTAOTK) = p_month AND YEAR(NGAYTAOTK) = p_year;
	RETURN SLKH;
END //
DELIMITER;
>>>>>>> 35d8303992bf4d98fde6b9bbafaca486bc0c3256

ALTER TABLE MAYBAY
ADD CONSTRAINT CHK_SOGHEVIP CHECK (SOGHEVIP >= 0); 